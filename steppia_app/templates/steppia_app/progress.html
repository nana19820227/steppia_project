{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BEING å†’é™ºãƒãƒƒãƒ— - ã‚¹ãƒ†ãƒƒãƒ”ã‚¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ --- */
        @keyframes splash-anim {
            0% { transform: translate(-50%, 0) scale(0.3); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
        }
        @keyframes swim-no-flip { 0% { transform: translateX(0); } 50% { transform: translateX(60px); } 100% { transform: translateX(0); } }

        :root { 
            --wood: #6D4C41; --grass: #DCECCF; --sky: #DCECCF; 
            --star-yellow: #FFF2AF; --completed: #FFE082; --text-black: #000000;
        }

        body { 
            background: var(--sky); margin: 0; padding: 0; 
            font-family: 'Zen Maru Gothic', sans-serif; 
            min-height: 100vh; width: 100%;
            display: flex; justify-content: center; align-items: flex-start;
            overflow-x: hidden; 
        }

        .dollhouse-frame { 
            position: relative; 
            min-width: 1300px; 
            min-height: 1250px; 
            background: var(--grass); 
            border: 15px solid var(--wood); 
            box-sizing: border-box; 
            margin: auto;
            z-index: 1; 
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ‘ãƒãƒ« --- */
        .header-panel { 
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%); 
            width: 95%; max-width: 800px; 
            background: rgba(255, 255, 255, 0.98); border: 4px solid var(--wood); 
            border-radius: 25px; padding: 12px 20px; z-index: 3000; 
            display: flex; flex-direction: column; align-items: center; gap: 10px; 
            box-shadow: 0 8px 25px rgba(0,0,0,0.2); 
        }

        .header-top { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        
        .company-controls { 
            display: flex; align-items: center; gap: 10px; width: 100%; 
            padding-top: 8px; border-top: 2px dashed rgba(109, 76, 65, 0.2);
        }

        select {
            flex-grow: 1; padding: 6px 12px; border-radius: 12px;
            border: 2px solid var(--wood); font-family: 'Zen Maru Gothic', sans-serif;
            font-weight: 900; font-size: 13px; color: var(--wood); cursor: pointer;
        }

        .btn-mini {
            padding: 6px 12px; border-radius: 12px; border: none; font-weight: 900; 
            font-size: 12px; cursor: pointer; color: white; transition: 0.2s;
        }
        .btn-add { background: #81C784; box-shadow: 0 3px 0 #689F38; }
        .btn-warp { background: #F48FB1; box-shadow: 0 3px 0 #C2185B; }
        .btn-del { background: #e57373; box-shadow: 0 3px 0 #c62828; }

        /* --- ğŸ†• æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®é…ç½®èª¿æ•´ï¼ˆãƒãƒ©ãƒ³ã‚¹é‡è¦–ï¼‰ --- */
        .bottom-nav { 
            position: fixed !important; bottom: 40px; left: 45px; z-index: 4000; 
        }

        .star-link-btn { 
            position: relative; display: flex; align-items: center; justify-content: center; 
            width: 100px; height: 100px; text-decoration: none; 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .star-link-btn:hover { transform: scale(1.1) rotate(-5deg); }

        .star-icon { font-size: 100px; color: var(--star-yellow); filter: drop-shadow(0 6px 15px rgba(0,0,0,0.15)); }
        .star-text { 
            position: absolute; font-size: 20px; font-weight: 900; color: var(--text-black); 
            top: 50%; left: 50%; transform: translate(-50%, -45%); 
        }

        /* --- ãƒãƒƒãƒ—è¦ç´  --- */
        .step-tile { 
            position: absolute; width: 160px; height: 85px; background: #FFFFFF; 
            border: 3px solid var(--wood); border-radius: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 50; box-shadow: 0 7px 0 rgba(0,0,0,0.08); padding: 0 8px; 
        }
        .step-tile.completed { background: var(--completed); border-color: #FFA000; }
        .player-pawn { position: absolute; width: 85px; z-index: 200; transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); pointer-events: none; }

        .deco-item { position: absolute; pointer-events: none; z-index: 10; }
        
        /* --- ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½ç½® --- */
        .buranko-deco { top: 120px; left: 60px; width: 130px; z-index: 150; }
        .tree-deco { top: 100px; left: 1100px; width: 120px; z-index: 150; }
        
        /* ğŸ†• æ± ï¼ˆmagic-pondï¼‰ã‚’ä¸€å›ã‚Šå°ã•ãèª¿æ•´ */
        .magic-pond { top: 1040px; left: 280px; width: 220px; height: 140px; z-index: 150; background: #81D4FA; border: 6px solid #FFF; border-radius: 50% 40% 60% 30%; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        
        .funsui-area { top: 1080px; left: 1120px; width: 140px; z-index: 150; }
        .tobibako-deco { top: 1050px; left: 750px; width: 120px; z-index: 150; }

        /* ğŸ†• æ°´é£›æ²«ã®ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾© */
        .splash {
            position: absolute; width: 8px; height: 8px; background: white; border-radius: 50%; pointer-events: none;
        }

        @media (max-width: 768px) {
            .dollhouse-frame { transform: scale(0.28); transform-origin: top center; margin-top: 150px; margin-bottom: -850px; }
            .header-panel { width: 98%; padding: 10px; border-radius: 15px; }
            .bottom-nav { left: 25px; bottom: 30px; transform: scale(0.8); }
        }
    </style>
</head>
<body>
    <div class="dollhouse-frame">
        <svg id="path-svg" style="position:absolute; width:100%; height:100%; pointer-events:none; z-index:10;"><path id="path-line" fill="none" stroke="rgba(109, 76, 65, 0.15)" stroke-width="7" stroke-dasharray="12,12" /></svg>

        <div class="header-panel">
            <div class="header-top">
                <h2 style="font-size: 16px; margin: 0; color: var(--wood);">BEINGã‚’å¶ãˆã‚‹å†’é™ºèˆªè·¯</h2>
                <div style="display:flex; align-items:center; gap:8px;">
                    <input type="number" id="warp-val" value="1" min="1" max="30" style="width:45px; border-radius:10px; border:2px solid var(--wood); text-align:center; font-weight:900;">
                    <button onclick="warp()" class="btn-mini btn-warp">ç§»å‹•</button>
                </div>
            </div>
            
            <div class="company-controls">
                <select id="company-select" onchange="changeCompany(this.value)">
                    <option value="">ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
                <button onclick="addCompany()" class="btn-mini btn-add">+ è¿½åŠ </button>
                <button onclick="deleteCurrentCompany()" class="btn-mini btn-del">ğŸ—‘ï¸</button>
            </div>
        </div>

        <div class="deco-item magic-pond"><img src="{% static 'images/fish.png' %}" style="position:absolute; top:35%; width:40px; animation: swim-no-flip 10s linear infinite;"></div>
        
        <div class="deco-item funsui-area">
            <img src="{% static 'images/funsui.png' %}" class="funsui-img" style="width:100%; display:block;">
            <div id="splash-container" style="position:absolute; top:20px; left:50%; width:40px; height:20px;"></div>
        </div>

        <img src="{% static 'images/midorinoki.png' %}" class="deco-item tree-deco">
        <img src="{% static 'images/buranko.png' %}" class="deco-item buranko-deco">
        <img src="{% static 'images/tobibako.png' %}" class="deco-item tobibako-deco">
        
        <img src="{% static 'images/onna.png' %}" class="player-pawn" id="pawn" style="display:none;">
        <div id="grid-root"></div>
    </div>

    <div class="bottom-nav">
        <a href="{% url 'menu' %}" class="star-link-btn">
            <span class="star-icon">â˜…</span>
            <span class="star-text">æˆ»ã‚‹</span>
        </a>
    </div>

    <script>
        let companies = JSON.parse(localStorage.getItem('steppia_companies')) || {};
        let currentCompanyId = localStorage.getItem('steppia_current_id') || '';

        const missionNames = ["çµŒé¨“ãƒ»ã‚¹ã‚­ãƒ«ã®æ£šå¸ã—", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡â‘ ï¼šè¨ºæ–­", "ä¾¡å€¤è¦³ã®è¨€èªåŒ–(AI)", "å¼·ã¿ãƒ»æ­¦å™¨ã®æ˜ç¢ºåŒ–", "è»¢è·è»¸ã¨BEINGç¢ºå®š", "æ¥­ç•Œãƒ»è·ç¨®ã®å¸‚å ´èª¿æŸ»", "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä¼æ¥­é¸å®š", "è·å‹™çµŒæ­´æ›¸ãƒ‰ãƒ©ãƒ•ãƒˆä½œæˆ", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡â‘¡ï¼šæ›¸é¡æ·»å‰Š", "å¿—æœ›å‹•æ©Ÿãƒ»PRã®æœ€é©åŒ–", "å¿œå‹Ÿãƒãƒ£ãƒãƒ«é¸å®šãƒ»ç™»éŒ²", "å¿œå‹Ÿè¨ˆç”»ã®ç­–å®š", "ã‚¨ãƒ³ãƒˆãƒªãƒ¼é–‹å§‹ï¼", "ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡ã®å®Ÿè·µ", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡â‘¢ï¼šæŒ¯ã‚Šè¿”ã‚Š", "æ›¸é¡é¸è€ƒã®æ”¹å–„(AI)", "é©æ€§æ¤œæŸ»ãƒ»SPIå¯¾ç­–", "é¢æ¥å›ç­”æ¡ˆã®ä½œæˆ(AI)", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡â‘£ï¼šæ¨¡æ“¬é¢æ¥", "1æ¬¡é¢æ¥æŒ‘æˆ¦(ç¾å ´)", "é¢æ¥FBì˜æ•´ç†ã¨æ”¹å–„", "ğŸŒŸãŠè©¦ã—ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³æŒ‘æˆ¦", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡â‘¤ï¼šæœ€çµ‚å¯¾ç­–", "2æ¬¡é¢æ¥æŒ‘æˆ¦(ç®¡ç†è·)", "ä¼æ¥­ç ”ç©¶ã®æ›´ãªã‚‹æ·±æ˜ã‚Š", "é€†è³ªå•ãƒ»ãƒ—ãƒ¬ã‚¼ãƒ³æº–å‚™", "æœ€çµ‚é¢æ¥æŒ‘æˆ¦(çµŒå–¶å±¤)", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡â‘¥ï¼šç›¸è«‡", "æ¡ä»¶ç¢ºèªãƒ»æ„æ€æ±ºå®š", "ğŸ‰ã‚­ãƒ£ãƒªã‚¢å§‹å‹•ï¼"];
        let nodePoints = [];

        function renderMap() {
            const root = document.getElementById('grid-root'); root.innerHTML = ''; nodePoints = [];
            const startX = 120; const startY = 240;
            const gapX = 190; const gapY = 140;

            for (let i = 1; i <= 30; i++) {
                const row = Math.floor((i - 1) / 6); const col = (i - 1) % 6; const isRev = row % 2 !== 0;
                const x = isRev ? (5 - col) * gapX + startX : col * gapX + startX; 
                const y = row * gapY + startY;
                const tile = document.createElement('div'); tile.className = 'step-tile'; 
                tile.style.left = x + 'px'; tile.style.top = y + 'px';
                tile.innerHTML = `<div style="font-size:9px; opacity:0.6; font-weight:900;">STEP ${i}</div><div style="width:100%; text-align:center; font-weight:900; font-size:11px; color:var(--wood);">${missionNames[i-1]}</div>`;
                root.appendChild(tile); nodePoints.push({x: x + 80, y: y + 42.5});
            }
            drawPath(); updateView();
        }

        function updateView() {
            const pawn = document.getElementById('pawn');
            const select = document.getElementById('company-select');
            select.innerHTML = '<option value="">ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            for (const id in companies) {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = `${companies[id].name} (STEP ${companies[id].step})`;
                if (id === currentCompanyId) opt.selected = true;
                select.appendChild(opt);
            }

            if (!currentCompanyId || !companies[currentCompanyId]) {
                currentCompanyId = '';
                if(pawn) pawn.style.display = 'none';
                document.querySelectorAll('.step-tile').forEach(t => t.classList.remove('completed'));
            } else {
                const step = companies[currentCompanyId].step;
                document.getElementById('warp-val').value = step;
                const p = nodePoints[step - 1];
                if(pawn && p) {
                    pawn.style.display = 'block';
                    pawn.style.left = (p.x - 42) + 'px'; pawn.style.top = (p.y - 105) + 'px';
                }
                document.querySelectorAll('.step-tile').forEach((t, idx) => { t.classList.toggle('completed', idx < step); });
                if (step === 30) { setTimeout(() => { window.location.href = "{% url 'congrats_map' %}"; }, 1300); }
            }
            localStorage.setItem('steppia_companies', JSON.stringify(companies));
            localStorage.setItem('steppia_current_id', currentCompanyId);
        }

        function changeCompany(id) { currentCompanyId = id; updateView(); }
        function addCompany() { const name = prompt("ä¼æ¥­åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); if (name) { const id = 'c' + Date.now(); companies[id] = { name: name, step: 1 }; currentCompanyId = id; updateView(); } }
        function deleteCurrentCompany() { if (!currentCompanyId) return; if (confirm(`${companies[currentCompanyId].name} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) { delete companies[currentCompanyId]; currentCompanyId = ''; updateView(); } }
        function warp() { if(!currentCompanyId) return; const v = parseInt(document.getElementById('warp-val').value); companies[currentCompanyId].step = v; updateView(); }
        function drawPath() { const line = document.getElementById('path-line'); let d = `M ${nodePoints[0].x} ${nodePoints[0].y}`; for (let i = 1; i < nodePoints.length; i++) { d += ` L ${nodePoints[i].x} ${nodePoints[i].y}`; } line.setAttribute('d', d); }

        // ğŸ†• å™´æ°´ã®æ°´é£›æ²«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function createSplash() { 
            const container = document.getElementById('splash-container'); 
            if(!container) return; 
            const splash = document.createElement('div'); 
            splash.className = 'splash'; 
            // é£›ã¶æ–¹å‘ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ•£ã‚‰ã™
            splash.style.left = `${Math.random() * 100}%`; 
            const duration = Math.random() * 0.5 + 0.5; 
            splash.style.animation = `splash-anim ${duration}s ease-out forwards`; 
            container.appendChild(splash); 
            setTimeout(() => splash.remove(), duration * 1000); 
        }

        window.onload = () => { renderMap(); setInterval(createSplash, 150); }; // ç”Ÿæˆé€Ÿåº¦ã‚’ã‚¢ãƒƒãƒ—
    </script>
</body>
</html>