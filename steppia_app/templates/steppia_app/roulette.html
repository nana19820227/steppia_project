{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ÈÅã„Å†„ÇÅ„ÅóÔºÅ - „Çπ„ÉÜ„ÉÉ„Éî„Ç¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap" rel="stylesheet">
    <style>
        @keyframes fast-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        canvas.spinning { animation: fast-spin 0.4s linear infinite; }
        :root { --bg: #DCECCF; --white: #FFFFFF; --brown: #5D4037; --star-yellow: #FFF2AF; --text-black: #000000; }
        body { background-color: var(--bg); margin: 0; font-family: 'Zen Maru Gothic', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        h2 { font-size: 28px; font-weight: 900; color: var(--brown); margin-bottom: 30px; }
        .roulette-container { position: relative; width: 350px; height: 350px; }
        .pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid #FF5722; z-index: 100; }
        canvas { width: 350px; height: 350px; border-radius: 50%; border: 8px solid var(--white); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .controls { margin-top: 40px; display: flex; gap: 20px; }
        .btn { padding: 15px 40px; border: none; border-radius: 20px; font-size: 20px; font-weight: 900; cursor: pointer; box-shadow: 0 5px 0 rgba(0,0,0,0.1); transition: 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .start-btn { background: #FFA726; color: white; }
        .stop-btn { background: #F48FB1; color: white; }
        .bottom-nav { position: fixed; bottom: 30px; left: 30px; z-index: 1000; }
        .star-link-btn { position: relative; display: flex; align-items: center; justify-content: center; width: 130px; height: 130px; text-decoration: none; }
        .star-icon { font-size: 130px; color: var(--star-yellow); filter: drop-shadow(0 6px 15px rgba(0,0,0,0.12)); }
        .star-text { position: absolute; font-size: 26px; font-weight: 900; color: var(--text-black); top: 50%; left: 50%; transform: translate(-50%, -45%); transition: transform 0.3s; }
        .star-link-btn:hover .star-text { transform: translate(-50%, -45%) rotate(15deg); }
    </style>
</head>
<body>
    <h2>üéÅ ÈÅã„Å†„ÇÅ„Åó„É´„Éº„É¨„ÉÉ„Éà</h2>
    <div class="roulette-container">
        <div class="pointer"></div>
        <canvas id="canvas" width="350" height="350"></canvas>
    </div>
    <div id="status-msg" style="margin-top:20px; font-weight:900;">„Çπ„Çø„Éº„Éà„ÇíÊäº„Åó„Å¶„Å≠ÔºÅ</div>
    <div class="controls">
        <button id="startBtn" onclick="startRoulette()" class="btn start-btn">„Çπ„Çø„Éº„Éà</button>
        <button id="stopBtn" onclick="stopRoulette()" class="btn stop-btn" disabled>„Çπ„Éà„ÉÉ„Éó</button>
    </div>
    <div class="bottom-nav">
        <a href="{% url 'menu' %}" class="star-link-btn"><span class="star-icon">‚òÖ</span><span class="star-text">Êàª„Çã</span></a>
    </div>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const labels = ["ÁâπË≥û", "„Ç≥„É≥„Çµ„É´Èù¢Ë´á30ÂàÜ", "AË≥û", "„Éè„Ç∫„É¨", "BË≥û", "„Éè„Ç∫„É¨"];
        const colors = ["#FFF9C4", "#B9D9A0", "#FFCCBC", "#F1F8E9", "#F3E5F5", "#ECEFF1"];
        let isSpinning = false;

        function drawRoulette() {
            const numSegments = labels.length;
            const angleStep = (2 * Math.PI) / numSegments;
            for (let i = 0; i < numSegments; i++) {
                ctx.beginPath(); ctx.fillStyle = colors[i]; ctx.moveTo(175, 175);
                ctx.arc(175, 175, 175, i * angleStep, (i + 1) * angleStep); ctx.fill();
                ctx.save(); ctx.translate(175, 175); ctx.rotate(i * angleStep + angleStep / 2);
                ctx.textAlign = "right"; ctx.fillStyle = "#5D4037";
                const fontSize = labels[i].length > 4 ? "14px" : "18px";
                ctx.font = `bold ${fontSize} 'Zen Maru Gothic'`; ctx.fillText(labels[i], 160, 8); ctx.restore();
            }
        }

        function startRoulette() {
            if (isSpinning) return;
            isSpinning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            canvas.classList.add('spinning');
        }

        function stopRoulette() {
            if (!isSpinning) return;
            isSpinning = false;
            document.getElementById('stopBtn').disabled = true;
            const style = window.getComputedStyle(canvas);
            const matrix = new WebKitCSSMatrix(style.transform);
            const currentAngle = Math.atan2(matrix.b, matrix.a) * (180/Math.PI);
            canvas.classList.remove('spinning');
            const finalRotation = (currentAngle < 0 ? currentAngle + 360 : currentAngle) + 1080 + Math.floor(Math.random() * 360);
            canvas.style.transition = 'transform 4s cubic-bezier(0.15, 0, 0.15, 1)';
            canvas.style.transform = `rotate(${finalRotation}deg)`;
            setTimeout(() => {
                const numSegments = labels.length;
                const normalizedAngle = (270 - (finalRotation % 360) + 360) % 360;
                const index = Math.floor(normalizedAngle / (360 / numSegments));
                const resultItem = labels[index];
                
                // üÜï ‰øÆÊ≠£„Éù„Ç§„É≥„ÉàÔºö‰ΩôÂàÜ„Å™ /steppia/ „ÇíÂâäÈô§„Åó„ÄÅÊ≠£„Åó„ÅÑURL„Å∏ÈÅ∑Áßª
                window.location.href = `/roulette/result/${encodeURIComponent(resultItem)}/`;
            }, 4000);
        }
        drawRoulette();
    </script>
</body>
</html>
