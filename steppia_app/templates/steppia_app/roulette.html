{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‹ã ã‚ã—ï¼ - ã‚¹ãƒ†ãƒƒãƒ”ã‚¢</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --bg: #DCECCF; --white: #FFFFFF; --brown: #5D4037; --star-yellow: #FFF2AF; --text-black: #000000; }
        body { background-color: var(--bg); margin: 0; font-family: 'Zen Maru Gothic', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        h2 { font-size: 28px; font-weight: 900; color: var(--brown); margin-bottom: 20px; }
        .roulette-container { position: relative; width: 320px; height: 320px; }
        .pointer { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 25px solid #FF5722; z-index: 100; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
        canvas { width: 320px; height: 320px; border-radius: 50%; border: 8px solid var(--white); box-shadow: 0 10px 30px rgba(0,0,0,0.15); transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); }
        
        /* ğŸ†• é«˜é€Ÿå›è»¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fast-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: fast-spin 0.3s linear infinite; }

        .status-msg { margin-top: 25px; font-size: 20px; font-weight: 900; color: var(--brown); height: 30px; }
        .controls { margin-top: 30px; display: flex; gap: 15px; }
        .btn { padding: 12px 35px; border: none; border-radius: 50px; font-size: 18px; font-weight: 900; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
        
        .start-btn { background: #FFA726; color: white; }
        .stop-btn { background: #F48FB1; color: white; }

        .bottom-nav { position: fixed; bottom: 20px; left: 20px; z-index: 1000; }
        .star-link-btn { position: relative; display: flex; align-items: center; justify-content: center; width: 100px; height: 100px; text-decoration: none; }
        .star-icon { font-size: 100px; color: var(--star-yellow); filter: drop-shadow(0 4px 10px rgba(0,0,0,0.1)); }
        .star-text { position: absolute; font-size: 20px; font-weight: 900; color: var(--text-black); top: 50%; left: 50%; transform: translate(-50%, -45%); }
    </style>
</head>
<body>
    <h2>ğŸ é‹ã ã‚ã—ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ</h2>

    <div class="roulette-container">
        <div class="pointer"></div>
        <canvas id="canvas" width="350" height="350"></canvas>
    </div>

    <div id="status-msg" class="status-msg">
        {% if can_spin %}ã‚¹ã‚¿ãƒ¼ãƒˆã‚’æŠ¼ã—ã¦ã­ï¼{% else %}ä»Šæ—¥ã¯ã‚‚ã†å›ã—ãŸã‚ˆã€‚ã¾ãŸæ˜æ—¥ã­ï¼{% endif %}
    </div>

    <div class="controls">
        <button id="startBtn" onclick="startRoulette()" class="btn start-btn" {% if not can_spin %}disabled{% endif %}>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <button id="stopBtn" onclick="stopRoulette()" class="btn stop-btn" disabled>ã‚¹ãƒˆãƒƒãƒ—</button>
    </div>

    <div class="bottom-nav">
        <a href="{% url 'menu' %}" class="star-link-btn">
            <span class="star-icon">â˜…</span>
            <span class="star-text">æˆ»ã‚‹</span>
        </a>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusMsg = document.getElementById('status-msg');
        
        const labels = ["ç‰¹è³", "ã‚³ãƒ³ã‚µãƒ«é¢è«‡30åˆ†", "Aè³", "ãƒã‚ºãƒ¬", "Bè³", "ãƒã‚ºãƒ¬"];
        const colors = ["#FFF9C4", "#B9D9A0", "#FFCCBC", "#F1F8E9", "#F3E5F5", "#ECEFF1"];
        
        let isSpinning = false;

        function drawRoulette() {
            const numSegments = labels.length;
            const angleStep = (2 * Math.PI) / numSegments;
            for (let i = 0; i < numSegments; i++) {
                ctx.beginPath();
                ctx.fillStyle = colors[i];
                ctx.moveTo(175, 175);
                ctx.arc(175, 175, 175, i * angleStep, (i + 1) * angleStep);
                ctx.fill();
                ctx.save();
                ctx.translate(175, 175);
                ctx.rotate(i * angleStep + angleStep / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#5D4037";
                ctx.font = "bold 18px 'Zen Maru Gothic'";
                ctx.fillText(labels[i], 160, 8);
                ctx.restore();
            }
        }

        function startRoulette() {
            if (isSpinning) return;
            isSpinning = true;
            statusMsg.innerText = "ä½•ãŒå½“ãŸã‚‹ã‹ãª...ï¼Ÿ";
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            canvas.style.transition = "none";
            canvas.classList.add('spinning');
        }

        function stopRoulette() {
            if (!isSpinning) return;
            isSpinning = false;
            document.getElementById('stopBtn').disabled = true;

            // é«˜é€Ÿå›è»¢ã‚’æ­¢ã‚ã¦ã€ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã¾ã§æ»‘ã‚‰ã‹ã«å›è»¢ã•ã›ã‚‹
            const extraDegree = Math.floor(Math.random() * 360);
            const finalRotation = 1440 + extraDegree; // 4å›è»¢ + ãƒ©ãƒ³ãƒ€ãƒ è§’
            
            canvas.classList.remove('spinning');
            canvas.style.transition = 'transform 4s cubic-bezier(0.15, 0, 0.15, 1)';
            canvas.style.transform = `rotate(${finalRotation}deg)`;

            statusMsg.innerText = "ãƒ‰ã‚­ãƒ‰ã‚­â€¦â€¦";

            setTimeout(() => {
                const numSegments = labels.length;
                const actualDegree = finalRotation % 360;
                // é‡ï¼ˆçœŸä¸Š=270åº¦ï¼‰ã®ä½ç½®ã‹ã‚‰å½“é¸é …ç›®ã‚’è¨ˆç®—
                const index = Math.floor(((270 - actualDegree + 360) % 360) / (360 / numSegments));
                const resultItem = labels[index];

                statusMsg.innerText = `çµæœã¯ã€Œ${resultItem}ã€ï¼`;

                // ğŸ†• å½“ãŸã‚Šãªã‚‰ç´™å¹é›ªã‚’é£›ã°ã™
                if (!resultItem.includes("ãƒã‚ºãƒ¬")) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                }

                // ğŸ†• ç¢ºå®Ÿã«çµæœã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«1.5ç§’å¾Œã«ã‚¸ãƒ£ãƒ³ãƒ—
                setTimeout(() => {
                    const targetUrl = `/roulette/result/${encodeURIComponent(resultItem)}/`;
                    window.location.href = targetUrl;
                }, 1500);

            }, 4000);
        }

        drawRoulette();
    </script>
</body>
</html>